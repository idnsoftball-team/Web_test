/* GAS.gs - v17.0 Final (Password Fixed) */

// === 1. 設定區 ===
const SPREADSHEET_ID = '1mRcCNQSlTVwRRy7u9Yhx9knsw_0ZUyI0p6dMFgO-6os'; // [cite: 69]
const ADMIN_PASSWORD = 'kfet2026'; //  ★★★ 已修正 ★★★

// === 2. 請求入口 ===
function doGet(e) {
  // 瀏覽器直接訪問時的回應，用於測試連線
  return responseJSON({ status: 'success', message: 'GAS is Online. Please use POST for data.' });
}

function doPost(e) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000);
    const data = JSON.parse(e.postData.contents);
    const action = data.action;
    const payload = data.payload || {};
    const password = data.password;

    // --- 公開區 ---
    if (action === 'get_all_data') return getAllData();
    if (action === 'add_leave') return addLeave(payload);
    
    // --- 登入驗證 ---
    if (action === 'check_auth') {
      if (String(password) === String(ADMIN_PASSWORD)) {
        return responseJSON({ success: true, message: '登入成功' });
      } else {
        return responseJSON({ success: false, message: '密碼錯誤' });
      }
    }

    // --- 管理區驗證 ---
    if (String(password) !== String(ADMIN_PASSWORD)) {
      return responseJSON({ success: false, message: '密碼錯誤' });
    }

    switch (action) {
      case 'update_config':    return updateConfig(payload, 'admin');
      case 'save_player':      return savePlayer(payload, 'admin');
      case 'delete_player':    return softDelete('players', payload.rowId, 'admin');
      case 'save_schedule':    return saveSchedule(payload, 'admin');
      case 'delete_schedule':  return softDelete('training_schedule', payload.rowId, 'admin');
      case 'save_match':       return saveMatch(payload, 'admin');
      case 'delete_match':     return softDelete('matches', payload.rowId, 'admin');
      case 'add_announcement': return addAnnouncement(payload, 'admin');
      case 'delete_leave':     return softDelete('leave_requests', payload.rowId, 'admin');
      default: return responseJSON({ success: false, message: 'Unknown action' });
    }
  } catch (err) {
    return responseJSON({ success: false, message: 'Error: ' + err.toString() });
  } finally {
    lock.releaseLock();
  }
}

// === 3. 資料讀取 ===
function getAllData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const tables = ['announcements', 'players', 'staff', 'training_schedule', 'matches', 'leave_requests', 'config'];
    const result = {};
    tables.forEach(name => {
      let rows = getSheetData(ss, name);
      // 根據您的 CSV，is_deleted 欄位是最後一個 [cite: 79]
      rows = rows.filter(r => String(r.is_deleted || '').toUpperCase() !== 'TRUE');
      result[name] = rows;
    });
    
    const configObj = {};
    if (result.config) result.config.forEach(r => { if (r.key) configObj[r.key] = r.value; });
    result.hero = configObj;
    
    return responseJSON(result);
  } catch (e) {
    return responseJSON({ success: false, message: 'Read Error: ' + e.toString() });
  }
}

// === 4. 寫入功能 ===
function addAnnouncement(data, actor) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('announcements');
  const now = new Date();
  sheet.appendRow(['A' + now.getTime(), data.date, data.title, data.content, '', '', '', '', '', now, actor, now, actor, 'FALSE']);
  return responseJSON({ success: true });
}

function addLeave(data) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('leave_requests');
  const now = new Date();
  sheet.appendRow(['L' + now.getTime(), now, data.name, '', '', data.date, data.slot, data.reason, 'pending', 'FALSE']);
  return responseJSON({ success: true });
}

function savePlayer(data, actor) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('players');
  const headers = getHeaders(sheet);
  const now = new Date();
  const fields = { student_name: data.name, grade: data.grade, class: data.class, paddle: data.paddle, is_active: 'TRUE' };
  
  if (data.rowId) updateRow(sheet, data.rowId, headers, fields, actor, now);
  else {
    fields.player_id = String(now.getTime());
    appendRow(sheet, headers, fields, actor, now);
  }
  return responseJSON({ success: true });
}

function saveMatch(data, actor) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('matches');
  const headers = getHeaders(sheet);
  const now = new Date();
  const fields = { 
    match_date: data.date, match_type: data.type, 
    player1_id: data.p1, player2_id: data.p2, 
    opponent1: data.o1, opponent2: data.o2, 
    game_score: data.score, set_scores: data.sets, media_url: data.video 
  };
  
  if (data.rowId) updateRow(sheet, data.rowId, headers, fields, actor, now);
  else {
    fields.match_id = 'M' + now.getTime();
    appendRow(sheet, headers, fields, actor, now);
  }
  return responseJSON({ success: true });
}

function saveSchedule(data, actor) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName('training_schedule');
  const headers = getHeaders(sheet);
  const now = new Date();
  const fields = { weekday: data.weekday, slot: data.slot, table_no: data.table, coach_id: data.coachId, player_a_id: data.playerAId, player_b_id: data.playerBId, note: data.note, is_active: 'TRUE' };
  
  if (data.rowId) updateRow(sheet, data.rowId, headers, fields, actor, now);
  else {
    fields.schedule_id = 'S' + now.getTime();
    appendRow(sheet, headers, fields, actor, now);
  }
  return responseJSON({ success: true });
}

function softDelete(name, id, actor) {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(name);
  const headers = getHeaders(sheet);
  const idx = parseInt(id, 10);
  if (!idx || idx < 2) return responseJSON({ success: false });
  updateRow(sheet, idx, headers, { is_deleted: 'TRUE' }, actor, new Date());
  return responseJSON({ success: true });
}

function updateConfig(data, actor) { return responseJSON({ success: true }); }
function updateLeave(data, actor) { return responseJSON({ success: true }); }

// === 5. 輔助函式 ===
function getHeaders(sheet) { return sheet.getDataRange().getValues()[0]; }
function getSheetData(ss, name) {
  const s = ss.getSheetByName(name);
  if (!s) return [];
  const v = s.getDataRange().getValues();
  if (v.length < 2) return [];
  const h = v[0];
  const r = [];
  for (let i = 1; i < v.length; i++) {
    const row = v[i];
    const obj = { rowId: i + 1 };
    h.forEach((k, x) => { 
      let val = row[x];
      if (val instanceof Date) val = Utilities.formatDate(val, Session.getScriptTimeZone(), 'yyyy-MM-dd');
      obj[k] = (val === undefined) ? '' : val; 
    });
    r.push(obj);
  }
  return r;
}
function updateRow(sheet, idx, headers, data, actor, now) {
  for (const [k, v] of Object.entries(data)) {
    const c = headers.indexOf(k) + 1;
    if (c > 0) sheet.getRange(idx, c).setValue(v);
  }
  const uAt = headers.indexOf('updated_at') + 1;
  const uBy = headers.indexOf('updated_by') + 1;
  if (uAt > 0) sheet.getRange(idx, uAt).setValue(now);
  if (uBy > 0) sheet.getRange(idx, uBy).setValue(actor);
}
function appendRow(sheet, headers, data, actor, now) {
  const row = new Array(headers.length).fill('');
  for (const [k, v] of Object.entries(data)) {
    const c = headers.indexOf(k);
    if (c > -1) row[c] = v;
  }
  const meta = { created_at: now, created_by: actor, updated_at: now, updated_by: actor, is_deleted: 'FALSE' };
  for (const [k, v] of Object.entries(meta)) {
    const c = headers.indexOf(k);
    if (c > -1) row[c] = v;
  }
  sheet.appendRow(row);
}
function responseJSON(d) { return ContentService.createTextOutput(JSON.stringify(d)).setMimeType(ContentService.MimeType.JSON); }